{% extends "invent/requestor_dashboard.html" %}
{% load static %}

{% block title %}Request Device{% endblock %}

{% block main_content %}
<div class="container-fluid mt-4">
    <h2 class="mb-4 text-primary fw-bold">Request a Device</h2>

    {% if messages %}
        <div class="mb-3">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show py-2" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close btn-sm" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="card shadow-sm p-4 request-card">
        <form method="post" id="deviceRequestForm">
            {% csrf_token %}
            
            {{ form.oem_id_hidden }}
            {{ form.category_name_hidden }}
            {{ form.device_name_hidden }}

            <div class="row g-4">
                
                <div class="col-lg-6">

                    <div class="mb-3">
                        <label for="id_oem" class="form-label fw-semibold small">OEM</label>
                        <select name="oem" id="id_oem" class="form-select form-select-sm">
                            <option value="">Select OEM</option>
                            {% for oem in oems %}
                            <option value="{{ oem.id }}">{{ oem.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="id_category" class="form-label fw-semibold small">Category</label>
                        <select id="id_category" class="form-select form-select-sm" disabled>
                            <option value="">Select a category</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="id_device_name" class="form-label fw-semibold small">Device Name</label>
                        <select id="id_device_name" class="form-select form-select-sm" disabled>
                            <option value="">Select a device</option>
                        </select>
                        {{ form.device }}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.quantity.id_for_label }}" class="form-label fw-semibold small">{{ form.quantity.label }}</label>
                        {{ form.quantity }}
                        <div class="text-danger small mt-1" id="quantity_error"></div>
                        {% for error in form.quantity.errors %}
                            <div class="text-danger small mt-1">{{ error }}</div>
                        {% endfor %}
                    </div>
                    
                    <div class="border rounded p-3 bg-light mt-3">
                        <h6 class="fw-bold mb-2 small text-secondary">Device Information</h6>
                        <div class="row small text-muted">
                            <div class="col-6 mb-1">OEM: <span id="info_oem" class="fw-semibold">--</span></div>
                            <div class="col-6 mb-1">Category: <span id="info_category" class="fw-semibold">--</span></div>
                            <div class="col-12 mb-1">Device: <span id="info_device_name" class="fw-semibold">--</span></div>
                            <div class="col-6 mb-1">Available Qty: <span id="info_available_qty" class="fw-semibold">--</span></div>
                            <div class="col-6 mb-1">Status: <span id="info_status" class="fw-semibold">--</span></div>
                        </div>
                    </div>
                    
                    </div>

                <div class="col-lg-6">
                    <div class="border rounded p-3 bg-light h-100">
                        <h6 class="fw-bold text-primary mb-3 small">Client Information</h6>
                        <div class="row g-3">
                            <div class="col-12">
                                <label for="{{ form.client_name.id_for_label }}" class="form-label small">Name</label>
                                {{ form.client_name }}
                            </div>
                            <div class="col-12">
                                <label for="{{ form.client_phone.id_for_label }}" class="form-label small">Phone</label>
                                {{ form.client_phone }}
                            </div>
                            <div class="col-12">
                                <label for="{{ form.client_email.id_for_label }}" class="form-label small">Email</label>
                                {{ form.client_email }}
                            </div>
                            <div class="col-12">
                                <label for="{{ form.client_address.id_for_label }}" class="form-label small">Address</label>
                                {{ form.client_address }}
                            </div>
                            <div class="col-12">
                                <label for="{{ form.branch.id_for_label }}" class="form-label small">Branch</label>
                                {{ form.branch }}
                            </div>
                            {% for error in form.client_name.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
                            {% for error in form.client_phone.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
                            {% for error in form.client_email.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
                            {% for error in form.client_address.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
                            {% for error in form.branch.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-4 d-flex justify-content-end">
                <button type="submit" class="btn btn-success btn-sm px-4" id="submitBtn" disabled>
                    Submit Request
                    <span class="spinner-border spinner-border-sm d-none ms-2" id="submitSpinner" role="status"></span>
                </button>
            </div>
        </form>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
$(document).ready(function() {
    const $oemSelect = $('#id_oem');
    const $categorySelect = $('#id_category');
    const $deviceNameSelect = $('#id_device_name');
    const $quantityInput = $('#id_quantity');
    const $submitBtn = $('#submitBtn');
    
    // Hidden fields for POST validation
    const $oemIdHidden = $('#id_oem_id_hidden');
    const $categoryNameHidden = $('#id_category_name_hidden');
    const $deviceNameHidden = $('#id_device_name_hidden');
    
    // Info display spans
    const $infoOem = $('#info_oem');
    const $infoCategory = $('#info_category');
    const $infoDeviceName = $('#info_device_name');
    const $infoAvailableQty = $('#info_available_qty');
    const $infoStatus = $('#info_status');
    const $qtyError = $('#quantity_error');

    // --- Helper Functions ---
    function updateInfoCard(data) {
        $infoOem.text(data.oem || $oemSelect.find('option:selected').text() || '--');
        $infoCategory.text(data.category || '--');
        $infoDeviceName.text(data.name || '--');
        
        const availableQty = data.available_quantity !== undefined ? data.available_quantity : 0;
        
        $infoAvailableQty.text(availableQty);
        $infoStatus.text(data.status || '--');
        
        // FIX: Ensure max is at least 1 if a device is selected, or 0 if none/not available.
        $quantityInput.attr('max', availableQty);
        
        // Reset quantity if it exceeds max
        if (parseInt($quantityInput.val()) > availableQty) {
            $quantityInput.val(1);
        }
        
        // If nothing is available, set min to 0 temporarily to prevent browser error, 
        // but the validation below will handle the error message.
        $quantityInput.attr('min', availableQty > 0 ? 1 : 0);
    }

    function checkFormValidity() {
        const currentQty = parseInt($quantityInput.val());
        const maxQty = parseInt($quantityInput.attr('max'));
        const isDeviceSelected = $deviceNameSelect.val() !== '';
        
        const isQtyValid = currentQty >= 1 && currentQty <= maxQty;
        
        // Enable submit only if a device is selected AND quantity is valid
        $submitBtn.prop('disabled', !(isQtyValid && isDeviceSelected));
        
        if (!isDeviceSelected) {
            $qtyError.text('Please select a device first.');
        } else if (currentQty < 1) {
            $qtyError.text('Quantity must be at least 1.');
        } else if (currentQty > maxQty) {
            $qtyError.text(`Quantity must be between 1 and ${maxQty}.`);
        } else {
            $qtyError.text('');
        }
    }

    function resetFilters(level = 0) {
        if (level <= 1) {
            $categorySelect.empty().append('<option value="">Select a category</option>').prop('disabled', true);
            $categoryNameHidden.val('');
        }
        if (level <= 2) {
            $deviceNameSelect.empty().append('<option value="">Select a device</option>').prop('disabled', true);
            $deviceNameHidden.val('');
        }
        updateInfoCard({available_quantity: 0}); // Reset card and max quantity to 0
        $quantityInput.val(1).attr('max', 0);
        checkFormValidity();
    }
    
    // --- AJAX Load Functions (Kept concise) ---
    function loadCategories(oemId) {
        if (!oemId) { resetFilters(1); return; }
        
        $categorySelect.prop('disabled', true).empty().append('<option value="">Loading...</option>');
        
        $.ajax({
            url: window.location.pathname,
            type: 'GET',
            data: { ajax: 'filter_options', oem_id: oemId },
            success: function(data) {
                resetFilters(2);
                $categorySelect.empty().append('<option value="">Select a category</option>').prop('disabled', false);
                if (data.categories && data.categories.length > 0) {
                    data.categories.forEach(category => {
                        $categorySelect.append(`<option value="${category}">${category}</option>`);
                    });
                }
            }
        });
    }

    function loadDeviceNames(oemId, categoryName) {
        if (!oemId || !categoryName) { resetFilters(2); return; }

        $deviceNameSelect.prop('disabled', true).empty().append('<option value="">Loading...</option>');
        
        $.ajax({
            url: window.location.pathname,
            type: 'GET',
            data: { ajax: 'filter_options', oem_id: oemId, category_name: categoryName },
            success: function(data) {
                resetFilters(3);
                $deviceNameSelect.empty().append('<option value="">Select a device</option>').prop('disabled', false);
                if (data.device_names && data.device_names.length > 0) {
                    data.device_names.forEach(name => {
                        $deviceNameSelect.append(`<option value="${name}">${name}</option>`);
                    });
                }
            }
        });
    }

    function loadDeviceInfo(oemId, categoryName, deviceName) {
        if (!oemId || !categoryName || !deviceName) {
            updateInfoCard({available_quantity: 0});
            checkFormValidity();
            return;
        }
        
        $infoAvailableQty.text('Loading...');
        $infoStatus.text('...');
        
        $.ajax({
            url: window.location.pathname,
            type: 'GET',
            data: { ajax: 'device_info', oem_id: oemId, category_name: categoryName, device_name: deviceName },
            success: function(data) {
                updateInfoCard(data);
                $oemIdHidden.val(oemId);
                $categoryNameHidden.val(categoryName);
                $deviceNameHidden.val(deviceName);
                checkFormValidity();
            },
            error: function() {
                updateInfoCard({available_quantity: 0, status: 'Error'});
                checkFormValidity();
            }
        });
    }

    // --- Event Handlers ---

    $oemSelect.on('change', function() {
        const oemId = $(this).val();
        $oemIdHidden.val(oemId); 
        loadCategories(oemId);
        // Do not call resetFilters(2) here, it's called inside loadCategories on success
    });

    $categorySelect.on('change', function() {
        const oemId = $oemSelect.val();
        const categoryName = $(this).val();
        $categoryNameHidden.val(categoryName); 
        loadDeviceNames(oemId, categoryName);
        // Do not call resetFilters(3) here, it's called inside loadDeviceNames on success
    });

    $deviceNameSelect.on('change', function() {
        const oemId = $oemSelect.val();
        const categoryName = $categorySelect.val();
        const deviceName = $(this).val();
        
        if (deviceName) {
            loadDeviceInfo(oemId, categoryName, deviceName);
        } else {
            updateInfoCard({available_quantity: 0});
            checkFormValidity();
        }
    });
    
    $quantityInput.on('input', checkFormValidity);
    
    // Initial state setup
    resetFilters(1); 
});
</script>

{% endblock %}