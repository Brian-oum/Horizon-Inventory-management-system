{% extends "invent/requestor_dashboard.html" %}
{% load static %}

{% block title %}Request Device{% endblock %}

{% block main_content %}
<div class="container-fluid mt-4">
    <h2 class="mb-4 greeting">Request Device</h2>

    <!-- Django Messages -->
    {% if messages %}
        <div class="messages mb-3">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="card p-4 shadow-sm">
        <form method="post" id="deviceRequestForm">
            {% csrf_token %}

            <!-- Category Dropdown -->
            <div class="mb-3">
                <label for="id_category" class="form-label">Category:</label>
                <select id="id_category" class="form-control">
                    <option value="">Select a category</option>
                    {% for category in categories %}
                        <option value="{{ category }}">{{ category }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Device Dropdown -->
            <div class="mb-3">
                <label for="{{ form.device.id_for_label }}" class="form-label">{{ form.device.label }}:</label>
                <select name="device" id="id_device" class="form-control">
                    <option value="">Select a device</option>
                    {% for device in available_devices %}
                        <option value="{{ device.id }}"
                                data-category="{{ device.category }}"
                                data-imei="{{ device.imei_no }}"
                                data-status="{{ device.status }}">
                            {{ device.imei_no }} - {{ device.box.number }}
                        </option>
                    {% endfor %}
                </select>
                {% for error in form.device.errors %}
                    <div class="text-danger small">{{ error }}</div>
                {% endfor %}
            </div>

            <!-- Device Info -->
            <div class="border rounded p-3 mb-3 bg-light">
                <h6 class="fw-bold">Device Information</h6>
                <p class="mb-1">IMEI: <span id="device_imei" class="fw-bold">--</span></p>
                <p class="mb-1">Model: <span id="device_model" class="fw-bold">--</span></p>
                <p>Status: <span id="device_status" class="fw-bold">--</span></p>
            </div>

            <!-- Quantity -->
            <div class="mb-3">
                <label for="{{ form.quantity.id_for_label }}" class="form-label">{{ form.quantity.label }}:</label>
                {{ form.quantity }}
                {% for error in form.quantity.errors %}
                    <div class="text-danger small">{{ error }}</div>
                {% endfor %}
            </div>

            <!-- Reason -->
            <div class="mb-3">
                <label for="{{ form.reason.id_for_label }}" class="form-label">{{ form.reason.label }}:</label>
                {{ form.reason }}
                {% for error in form.reason.errors %}
                    <div class="text-danger small">{{ error }}</div>
                {% endfor %}
            </div>

            <!-- Client Details -->
            <h4 class="mt-4">Client Information</h4>

            <div class="mb-3">
                <label for="{{ form.client_name.id_for_label }}" class="form-label">Client Name:</label>
                {{ form.client_name }}
                {% for error in form.client_name.errors %}
                    <div class="text-danger small">{{ error }}</div>
                {% endfor %}
            </div>

            <div class="mb-3">
                <label for="{{ form.client_phone.id_for_label }}" class="form-label">Client Phone:</label>
                {{ form.client_phone }}
                {% for error in form.client_phone.errors %}
                    <div class="text-danger small">{{ error }}</div>
                {% endfor %}
            </div>

            <div class="mb-3">
                <label for="{{ form.client_email.id_for_label }}" class="form-label">Client Email:</label>
                {{ form.client_email }}
                {% for error in form.client_email.errors %}
                    <div class="text-danger small">{{ error }}</div>
                {% endfor %}
            </div>

            <div class="mb-3">
                <label for="{{ form.client_address.id_for_label }}" class="form-label">Client Address:</label>
                {{ form.client_address }}
                {% for error in form.client_address.errors %}
                    <div class="text-danger small">{{ error }}</div>
                {% endfor %}
            </div>

            <!-- Submit Button -->
            <button type="submit" class="btn btn-success" id="submitBtn">
                Submit Request
                <span class="spinner-border spinner-border-sm d-none ms-2" role="status" aria-hidden="true" id="submitSpinner"></span>
            </button>
        </form>
    </div>
</div>

<!-- Select2 and jQuery -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    $(document).ready(function () {
    const categorySelect = $('#id_category');
    const deviceSelect = $('#id_device');
    const imeiSpan = $('#device_imei');
    const modelSpan = $('#device_model');
    const statusSpan = $('#device_status');

    // Store all devices (exclude placeholder)
    const allDevices = deviceSelect.find('option').map(function () {
        const opt = $(this);
        if (!opt.val()) return null;
        return {
            id: opt.val(),
            text: opt.text(),
            category: opt.data('category'),
            imei: opt.data('imei'),
            status: opt.data('status')
        };
    }).get();

    // Initialize Select2
    deviceSelect.select2({ placeholder: 'Select a device', width: '100%' });

    // Filter devices when category changes
    categorySelect.on('change', function () {
        const selectedCategory = $(this).val();

        // Clear and repopulate
        deviceSelect.empty().append('<option value="">Select a device</option>');

        allDevices.filter(d => d.category === selectedCategory)
                  .forEach(d => {
                      deviceSelect.append(
                          `<option value="${d.id}" data-category="${d.category}" data-imei="${d.imei}" data-status="${d.status}">${d.text}</option>`
                      );
                  });

        deviceSelect.val(null).trigger('change');

        imeiSpan.text('--');
        modelSpan.text('--');
        statusSpan.text('--');
    });

    // Update device info
    deviceSelect.on('change', function () {
        const selectedOption = $(this).find('option:selected');
        if (selectedOption.val()) {
            imeiSpan.text(selectedOption.data('imei'));
            modelSpan.text(selectedOption.data('category'));
            statusSpan.text(selectedOption.data('status'));
        } else {
            imeiSpan.text('--');
            modelSpan.text('--');
            statusSpan.text('--');
        }
    });
});

</script>
{% endblock main_content %}
