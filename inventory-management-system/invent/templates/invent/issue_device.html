{% extends 'invent/base_store_clerk.html' %}
{% load static %}

{% block title %}Issue IoT Device (FIFO Box Logic){% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Issue IoT Device (FIFO Box Management)</h2>
    {% if messages %}
        <div class="messages mb-3">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    {% if box %}
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title mb-2">Current Box for Issuance: <strong>{{ box.number }}</strong> ({{ box.status|capfirst }})</h5>
                <p class="mb-0 text-muted">Only devices from this box can be issued until completed.</p>
            </div>
        </div>
        <form method="post">
            {% csrf_token %}
            <div class="row mb-3">
                <div class="col-md-5 mb-2">
                    <label for="device_id" class="form-label"><strong>Select Device</strong></label>
                    <select name="device_id" id="device_id" class="form-select" required>
                        <option value="" disabled selected>-- Select Device (IMEI/Serial) --</option>
                        {% for device in available_devices %}
                        <option value="{{ device.id }}">
                            IMEI: {{ device.imei_no }}
                            {% if device.serial_no %} | Serial: {{ device.serial_no }}{% endif %}
                            | Status: {{ device.status|capfirst }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-5 mb-2">
                    <label for="client_id" class="form-label"><strong>Select Client</strong></label>
                    <select name="client_id" id="client_id" class="form-select" required>
                        <option value="" disabled selected>-- Select Client --</option>
                        {% for client in clients %}
                        <option value="{{ client.id }}">{{ client.name }} ({{ client.phone_no }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">Issue Device</button>
                </div>
            </div>
        </form>
        <div class="table-responsive mt-4">
            <table class="table table-hover table-striped">
                <thead class="table-dark">
                    <tr>
                        <th>IMEI</th>
                        <th>Serial #</th>
                        <th>MAC Address</th>
                        <th>Category</th>
                        <th>Description</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for device in available_devices %}
                    <tr>
                        <td>{{ device.imei_no }}</td>
                        <td>{{ device.serial_no|default:"N/A" }}</td>
                        <td>{{ device.mac_address|default:"N/A" }}</td>
                        <td>{{ device.category|default:"N/A" }}</td>
                        <td>{{ device.description|default:"" }}</td>
                        <td><span class="badge bg-success">{{ device.status|capfirst }}</span></td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center text-muted">No available devices in this box.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="alert alert-info">
            <strong>No boxes are available for device issuance at this time.</strong>
        </div>
    {% endif %}
</div>
{% endblock %}